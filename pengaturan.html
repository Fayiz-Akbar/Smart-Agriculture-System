<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgroTech - Pengaturan</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        :root {
            --bg-main: #f4f7fa; --sidebar-bg: #ffffff; --card-bg: #ffffff;
            --primary-accent: #2a9d8f; --primary-light: #eaf6f5;
            --text-dark: #2c3e50; --text-muted: #8a99a8; --border-color: #e8edf2;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-main); color: var(--text-dark); display: flex; min-height: 100vh; }
        
        /* Sidebar */
        .sidebar { width: 280px; background: var(--sidebar-bg); padding: 30px 20px; height: 100vh; position: fixed; display: flex; flex-direction: column; border-right: 1px solid var(--border-color); }
        .sidebar-header { display: flex; align-items: center; gap: 15px; margin-bottom: 50px; }
        .sidebar-header i { font-size: 2.2em; color: var(--primary-accent); }
        .sidebar-header h2 { font-size: 1.6em; font-weight: 700; color: var(--text-dark); }
        .sidebar-nav ul { list-style: none; }
        .sidebar-nav li { margin-bottom: 8px; }
        .sidebar-nav li a { display: flex; align-items: center; gap: 15px; padding: 16px 18px; border-radius: 12px; text-decoration: none; color: var(--text-muted); font-weight: 600; font-size: 0.95em; transition: all 0.3s ease; }
        .sidebar-nav li a:hover { background: var(--primary-light); color: var(--primary-accent); }
        .sidebar-nav li a.active { background: var(--primary-accent); color: #ffffff; }
        .sidebar-nav li a i { font-size: 1.2em; width: 24px; }

        /* Main Content */
        .main-content { flex-grow: 1; margin-left: 280px; padding: 40px 50px; }
        .main-header { margin-bottom: 40px; }
        .main-header h1 { font-size: 2.5em; font-weight: 700; margin-bottom: 8px; color: var(--text-dark); }
        .main-header p { color: var(--text-muted); font-size: 1.05em; }

        /* Card */
        .card { background: var(--card-bg); border-radius: 16px; padding: 0; border: 1px solid var(--border-color); box-shadow: var(--shadow); }
        .card-body { padding: 30px; }
        .card-footer { padding: 20px 30px; background-color: #f8f9fb; border-top: 1px solid var(--border-color); border-radius: 0 0 16px 16px; text-align: right; }

        /* Settings Item */
        .setting-item { display: flex; justify-content: space-between; align-items: center; padding: 25px 0; border-bottom: 1px solid var(--border-color); }
        .setting-item:first-of-type { padding-top: 0; }
        .setting-item:last-of-type { border-bottom: none; }
        .setting-item .description { flex-grow: 1; padding-right: 20px; }
        .setting-item .description h4 { margin: 0 0 5px; font-weight: 600; }
        .setting-item .description p { margin: 0; color: var(--text-muted); font-size: 0.9em; }
        .setting-item .control { flex-shrink: 0; width: 50%; }

        /* Controls */
        .slider-container { display: flex; align-items: center; gap: 20px; }
        input[type="range"] { -webkit-appearance: none; appearance: none; flex-grow: 1; height: 8px; background: var(--border-color); border-radius: 5px; outline: none; background-image: linear-gradient(var(--primary-accent), var(--primary-accent)); background-size: 35% 100%; background-repeat: no-repeat; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 22px; height: 22px; background: var(--primary-accent); cursor: pointer; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .slider-value { font-weight: 600; font-size: 1.2em; color: var(--primary-accent); min-width: 50px; text-align: right; }
        .input-numeric { width: 100px; text-align: center; padding: 10px !important; border: 1px solid var(--border-color); border-radius: 8px; font-weight: 600; }
        .save-btn { background-color: var(--primary-accent); color: white; border: none; padding: 12px 30px; border-radius: 8px; font-size: 1em; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .save-btn:hover { background-color: #248a7f; transform: translateY(-2px); }

        /* Toggle Switch */
        .toggle-switch { position: relative; display: inline-block; width: 52px; height: 28px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .toggle-slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .toggle-slider { background-color: var(--primary-accent); }
        input:checked + .toggle-slider:before { transform: translateX(24px); }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="sidebar-header">
            <i class="fa-solid fa-leaf"></i>
            <h2>AgroTech</h2>
        </div>
        <ul class="sidebar-nav">
            <li><a href="DashboardProyekIOT.html"><i class="fa-solid fa-table-columns"></i><span>Dashboard</span></a></li>
            <li><a href="analisis.html"><i class="fa-solid fa-chart-line"></i><span>Analisis Data</span></a></li>
            <li><a href="rekomendasi.html"><i class="fa-solid fa-lightbulb"></i><span>Rekomendasi</span></a></li>
            <li><a href="laporan.html"><i class="fa-solid fa-file-alt"></i><span>Laporan</span></a></li>
            <li><a href="#" class="active"><i class="fa-solid fa-cog"></i><span>Pengaturan</span></a></li>
        </ul>
    </nav>

    <div class="main-content">
        <header class="main-header">
            <h1>Pengaturan Sistem</h1>
            <p>Sesuaikan cara kerja otomatisasi dan kontrol alat.</p>
        </header>

        <div class="card">
            <form id="form-otomatisasi">
                <div class="card-body">
                    <h3>Kontrol Otomatisasi</h3>
                    
                    <div class="setting-item">
                        <div class="description">
                            <h4>Status Sistem Penyiraman Otomatis</h4>
                            <p>Jika dimatikan, pompa tidak akan menyala otomatis meskipun tanah kering.</p>
                        </div>
                        <div class="control" style="text-align: right;">
                            <label class="toggle-switch">
                                <input type="checkbox" id="status-sistem-toggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>

                    <div class="setting-item">
                        <div class="description">
                            <h4>Ambang Batas Kelembapan Tanah</h4>
                            <p>Pompa menyala jika kelembapan tanah turun di bawah nilai ini.</p>
                        </div>
                        <div class="control">
                            <div class="slider-container">
                                <input type="range" min="10" max="80" value="35" id="soil-threshold-slider">
                                <span class="slider-value" id="slider-value">35%</span>
                            </div>
                        </div>
                    </div>

                    <div class="setting-item">
                        <div class="description">
                            <h4>Durasi Penyiraman Otomatis (menit)</h4>
                            <p>Lama waktu pompa menyala dalam satu sesi penyiraman.</p>
                        </div>
                        <div class="control" style="max-width: 150px; float: right;">
                             <input class="input-numeric" type="number" value="15" id="durasi-siram-input">
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <button type="submit" class="save-btn" id="save-btn">Simpan Perubahan</button>
                </div>
            </form>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        const slider = document.getElementById('soil-threshold-slider');
        const sliderValue = document.getElementById('slider-value');
        const durasiInput = document.getElementById('durasi-siram-input');
        const statusToggle = document.getElementById('status-sistem-toggle');
        const saveButton = document.getElementById('save-btn');
        const form = document.getElementById('form-otomatisasi');

        function updateSliderProgress(value) {
            const progress = (value - slider.min) / (slider.max - slider.min) * 100;
            slider.style.backgroundSize = `${progress}% 100%`;
            sliderValue.textContent = `${value}%`;
        }
        slider.addEventListener('input', (e) => updateSliderProgress(e.target.value));

        // Load Data dari Database
        async function loadPengaturan() {
            try {
                const response = await fetch('api_pengaturan.php', { method: 'GET' });
                const result = await response.json();
                if (result.status === 'success' && result.data) {
                    const ambang = parseFloat(result.data.ambang_batas_tanah);
                    slider.value = ambang;
                    updateSliderProgress(ambang);
                    durasiInput.value = parseInt(result.data.durasi_siram_menit);
                    
                    // Set Toggle (1 = Checked, 0 = Unchecked)
                    statusToggle.checked = (result.data.status_sistem == 1);
                }
            } catch (error) { console.error(error); }
        }

        // Simpan Data ke Database
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            const originalText = saveButton.textContent;
            saveButton.textContent = 'Menyimpan...';
            saveButton.disabled = true;

            const dataToSave = {
                ambang_batas_tanah: parseFloat(slider.value),
                durasi_siram_menit: parseInt(durasiInput.value),
                status_sistem: statusToggle.checked ? 1 : 0
            };

            try {
                const response = await fetch('api_pengaturan.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(dataToSave)
                });
                const result = await response.json();
                
                if (result.status === 'success') {
                    saveButton.textContent = 'Berhasil Disimpan!';
                    saveButton.style.backgroundColor = '#2ecc71';
                } else { throw new Error(); }
            } catch (error) {
                saveButton.textContent = 'Gagal!';
                saveButton.style.backgroundColor = '#e74c3c'; 
            } finally {
                setTimeout(() => {
                    saveButton.textContent = originalText;
                    saveButton.disabled = false;
                    saveButton.style.backgroundColor = 'var(--primary-accent)';
                }, 2000);
            }
        });

        loadPengaturan();
    });
    </script>
</body>
</html>